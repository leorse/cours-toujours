{% extends "base.html" %}

{% block title %}{{ step.title }} - Cours Toujours!{% endblock %}

{% block content %}
<div class="unit-container">
    <!-- Course Content -->
    <div class="glass glass-panel content-area animate-fade-in">
        <header style="border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem; margin-bottom: 2rem;">
            <a href="/subjects/{{ step.subject_id }}#{{ step.id }}"
                style="color: var(--text-muted); text-decoration: none; font-size: 0.9rem;">&larr; Retour √† la route</a>
            <h1 style="margin-top: 0.5rem;">{{ step.title }}</h1>
            <p style="color: var(--secondary); font-size: 0.9rem;">{{ step.subtitle if step.subtitle else "" }}</p>
        </header>

        <!-- Dynamic Content Container -->
        <div id="progressive-content">
            <!-- Sections and exercises will be injected here -->
        </div>

        <div id="final-footer"
            style="display: none; margin-top: 3rem; text-align: center; padding: 2rem; border-top: 1px dashed var(--glass-border);">
            <h3 style="color: var(--success); margin-bottom: 1rem;">üéâ Bravo ! Tu as termin√© ce chapitre.</h3>
            <button class="btn-primary" onclick="finishStep()">Valider et continuer</button>
        </div>
    </div>
</div>

{% if user.is_admin %}
<div class="admin-toolbar glass"
    style="position: fixed; bottom: 20px; right: 20px; padding: 1rem; z-index: 1000; border: 1px solid var(--secondary);">
    <h4 style="margin: 0 0 0.5rem 0; color: var(--secondary);">Admin Mode</h4>
    <a href="/admin/validate_step/{{ step.id }}"
        style="display: block; width: 100%; font-size: 0.8rem; margin-bottom: 0.5rem; text-align: center; background: #eee; color: #333; text-decoration: none; padding: 2px;">Force
        Valider</a>
    <a href="/admin/invalidate_step/{{ step.id }}"
        style="display: block; width: 100%; font-size: 0.8rem; text-align: center; background: #fee; color: red; text-decoration: none; padding: 2px;">Invalider</a>
</div>
{% endif %}

<script id="course-markdown" type="application/json">{{ course.content_markdown | tojson }}</script>



<style>
    .theory-section {
        margin-bottom: 2rem;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease;
    }

    .theory-section.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .interleaved-exercise {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 2rem 0;
        display: none;
        position: relative;
    }

    .interleaved-exercise.visible {
        display: block;
        border-left: 4px solid var(--secondary);
    }

    .exercise-done {
        border-left-color: var(--success) !important;
        background: rgba(46, 204, 113, 0.05) !important;
    }

    .drop-zone {
        display: inline-block;
        min-width: 60px;
        min-height: 1.5em;
        border: 2px dashed var(--text-muted);
        border-radius: 6px;
        vertical-align: middle;
        margin: 0 0.5rem;
        text-align: center;
        padding: 0 0.5rem;
        background: rgba(255, 255, 255, 0.05);
    }

    .drop-zone.drag-over {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
    }

    .drop-zone.filled {
        border-style: solid;
        border-color: var(--success);
        color: var(--success);
        background: rgba(16, 185, 129, 0.1);
    }

    .draggable-item {
        padding: 0.5rem 1rem;
        background: var(--surface);
        border: 1px solid var(--glass-border);
        border-radius: 6px;
        cursor: grab;
        display: inline-block;
        margin: 0.2rem;
        user-select: none;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="/static/js/fraction_renderer.js"></script>
<script>
    const stepData = {
        id: "{{ step.id }}",
        exercises: {{ course.exercises | tojson if course.exercises else '[]' }}
    };
    const markdownText = JSON.parse(document.getElementById('course-markdown').textContent);
    stepData.rawContent = markdownText;
    const userId = {{ user.id }};
    const isAlreadyCompleted = {{ 'true' if user_progress and user_progress.is_completed else 'false' }};
    const isAdmin = {{ 'true' if user.is_admin else 'false' }};

    const sections = (stepData.rawContent || "").split('&&&').map(s => s.trim()).filter(s => s.length > 0);
    const container = document.getElementById('progressive-content');

    document.addEventListener('DOMContentLoaded', () => {
        if (isAlreadyCompleted) {
            renderFullContent();
        } else {
            renderSection(0);
        }
    });

    const answers = {};
    const userAnswers = {};

    function saveInput(input, index) {
        answers[index] = input.value;
    }

    function saveCloze(select, exIndex, holeIndex) {
        if (!answers[exIndex]) answers[exIndex] = [];
        if (!Array.isArray(answers[exIndex])) answers[exIndex] = [];
        answers[exIndex][holeIndex] = select.value;
    }

    function renderSection(index) {
        if (index >= sections.length) {
            document.getElementById('final-footer').style.display = 'block';
            return;
        }

        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'theory-section';
        sectionDiv.id = `section-${index}`;

        // Protect Math
        const mathBlocks = [];
        const protectedContent = sections[index].replace(/(\$\$[\s\S]+?\$\$|\$[^\$\n]+?\$)/g, (match) => {
            const idx = mathBlocks.length;
            mathBlocks.push(match);
            return `<span class="math-px" data-idx="${idx}"></span>`;
        });

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = marked.parse(protectedContent);

        // Restore Math safely
        tempDiv.querySelectorAll('.math-px').forEach(span => {
            const idx = span.getAttribute('data-idx');
            const mathText = mathBlocks[idx];
            span.replaceWith(document.createTextNode(mathText));
        });

        // Placeholder Replacement: Find &&exercise_id&&
        let contentHtml = tempDiv.innerHTML;
        // Robust regex to handle potential HTML escaping of & by marked
        const exerciseRegex = /(?:&&|&amp;&amp;)([\w-]+)(?:&&|&amp;&amp;)/g;
        const foundExIds = [];

        contentHtml = contentHtml.replace(exerciseRegex, (match, exId) => {
            foundExIds.push(exId);
            return `<div id="ph-${exId}" class="exercise-placeholder"></div>`;
        });
        tempDiv.innerHTML = contentHtml;

        sectionDiv.appendChild(tempDiv);
        container.appendChild(sectionDiv);

        renderMathInElement(sectionDiv, {
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false }
            ],
            throwOnError: false
        });

        setTimeout(() => sectionDiv.classList.add('visible'), 10);

        // Render the exercises found in this section
        if (foundExIds.length > 0) {
            foundExIds.forEach(exId => {
                const ex = stepData.exercises.find(e => e.id === exId);
                if (ex) {
                    renderExerciseInPlaceholder(exId, ex, index);
                } else {
                    const ph = document.getElementById(`ph-${exId}`);
                    if (ph) ph.innerHTML = `<p class="text-error">Exercice introuvable : ${exId}</p>`;
                }
            });
        } else {
            if (index < sections.length - 1) {
                showContinueButton(index);
            }
        }
    }

    function showContinueButton(index) {
        // Prevent duplicate buttons
        if (document.getElementById(`next-btn-${index}`)) return;

        const nextBtn = document.createElement('button');
        nextBtn.id = `next-btn-${index}`;
        nextBtn.className = 'btn-secondary animate-fade-in';
        nextBtn.style.margin = '1rem 0 3rem 0';
        nextBtn.textContent = 'Continuer la lecture ‚¨áÔ∏è';
        nextBtn.onclick = (e) => {
            e.target.remove();
            renderSection(index + 1);
        };
        container.appendChild(nextBtn);
    }

    function renderExerciseInPlaceholder(exId, ex, sectionIndex) {
        const ph = document.getElementById(`ph-${exId}`);
        if (!ph) return;

        const exDiv = document.createElement('div');
        exDiv.className = 'interleaved-exercise visible';
        exDiv.id = `ex-wrapper-${exId}`;
        exDiv.dataset.section = sectionIndex;

        let adminBtnHtml = '';
        if (isAdmin) {
            adminBtnHtml = `
                    <button onclick='solveExerciseById("${exId}")' 
                            style="position: absolute; top: 0; right: 0; background: var(--secondary); color: white; border: none; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; z-index: 10;">
                        Auto-Valid (Admin)
                    </button>
                    `;
        }

        exDiv.innerHTML = `
            <div style="font-weight: bold; color: var(--secondary); margin-bottom: 1rem;">‚úçÔ∏è Petite v√©rification...</div>
            ${adminBtnHtml}
            <div id="ex-cont-${exId}"></div>
            <div id="ex-fb-${exId}" style="margin-top: 1rem; font-weight: bold; display: none;"></div>
            <button id="ex-bt-${exId}" class="btn-primary" style="margin-top: 1rem;" onclick="validateExerciseById('${exId}')">V√©rifier</button>
        `;
        ph.appendChild(exDiv);

        const contentDiv = document.getElementById(`ex-cont-${exId}`);
        if (ex.type === 'qcm' || ex.type === 'multiselect') {
            const isMulti = ex.type === 'multiselect';
            contentDiv.innerHTML = `
                <p style="margin-bottom: 0.5rem;">${ex.question}</p>
                ${isMulti ? '<p style="font-size: 0.7rem; color: var(--secondary); margin-bottom: 1rem;">(Plusieurs r√©ponses possibles)</p>' : ''}
                <div class="options-grid" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${ex.options.map(opt => `
                        <button class="option-btn" onclick="selectOptionById(this, '${exId}', '${opt.replace(/'/g, "\\'")}')">${opt}</button>
                    `).join('')}
                </div>
            `;
        } else if (ex.type === 'drag_drop') {
            let templateText = ex.template || '';
            let parts = templateText.split(/\.\.\.|\?\?\?/);
            let newHtml = '';

            parts.forEach((part, i) => {
                newHtml += part;
                if (i < parts.length - 1) {
                    newHtml += `<span class="drop-zone" id="zone-${exId}-${i}" ondrop="onDropById(event, '${exId}', ${i})" ondragover="allowDrop(event)"></span>`;
                }
            });

            contentDiv.innerHTML = `
                <div style="margin-bottom: 1rem; line-height: 2.2; font-size: 1.1rem;">${newHtml}</div>
                <div class="options-container" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${ex.options.map(opt => `
                        <div class="draggable-item" draggable="true" ondragstart="onDragStart(event, '${opt.replace(/'/g, "\\'")}')">${opt}</div>
                    `).join('')}
                </div>
            `;
        } else if (ex.type === 'fraction_scenario') {
            const visualId = `vs-${exId}`;
            contentDiv.innerHTML = `
                <div id="${visualId}" style="margin: 0 auto 1.5rem auto; width: 100%; max-width: 300px; height: 300px;"></div>
                <p style="margin-bottom: 1rem; font-size: 1.1rem;">${ex.question}</p>
                <input type="text" class="flash-input" style="font-size: 1.1rem; padding: 0.6rem;" placeholder="Votre r√©ponse" onchange="saveInputById(this, '${exId}')">
            `;
            setTimeout(() => {
                if (window.FractionRenderer) FractionRenderer.render(visualId, ex);
            }, 100);
        } else if (ex.type === 'cloze') {
            let templateText = ex.template || ex.question || '';
            let parts = templateText.split(/\.\.\.|\?\?\?/);
            let newHtml = '';
            parts.forEach((part, i) => {
                newHtml += part;
                if (i < parts.length - 1) {
                    newHtml += `
                        <select onchange="saveClozeById(this, '${exId}', ${i})" 
                                style="padding: 0.1rem; border-radius: 4px; background: rgba(255,255,255,0.1); color: var(--text-primary); border: 1px solid var(--glass-border);">
                            <option value="">...</option>
                            ${ex.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                    `;
                }
            });
            contentDiv.innerHTML = `<div style="margin-bottom: 1rem; line-height: 2.2;">${newHtml}</div>`;
        } else {
            contentDiv.innerHTML = `
                <p style="margin-bottom: 1rem; font-size: 1.1rem;">${ex.question || ex.template}</p>
                <input type="text" class="flash-input" style="font-size: 1.1rem; padding: 0.6rem;" placeholder="Votre r√©ponse" onchange="saveInputById(this, '${exId}')">
            `;
        }

        renderMathInElement(contentDiv, {
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false }
            ],
            throwOnError: false
        });
    }

    const answersById = {};

    function saveInputById(input, exId) { answersById[exId] = input.value; }
    function saveClozeById(sel, exId, idx) {
        if (!answersById[exId]) answersById[exId] = [];
        answersById[exId][idx] = sel.value;
    }

    function selectOptionById(btn, exId, val) {
        const ex = stepData.exercises.find(e => e.id === exId);
        if (!ex) return;
        if (ex.type === 'multiselect') {
            if (!Array.isArray(answersById[exId])) answersById[exId] = [];
            if (answersById[exId].includes(val)) {
                answersById[exId] = answersById[exId].filter(v => v !== val);
                btn.classList.remove('selected');
            } else {
                answersById[exId].push(val);
                btn.classList.add('selected');
            }
        } else {
            btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            answersById[exId] = val;
        }
    }

    function onDragStart(ev, value) {
        ev.dataTransfer.setData("text", value);
    }

    function allowDrop(ev) {
        ev.preventDefault();
        ev.target.classList.add('drag-over');
    }

    function onDropById(ev, exId, zoneIdx) {
        ev.preventDefault();
        ev.target.classList.remove('drag-over');
        const data = ev.dataTransfer.getData("text");
        ev.target.textContent = data;
        ev.target.classList.add('filled');
        if (!Array.isArray(answersById[exId])) answersById[exId] = [];
        answersById[exId][zoneIdx] = data;
    }

    function solveExerciseById(exId) {
        const ex = stepData.exercises.find(e => e.id === exId);
        if (!ex) return;
        const cont = document.getElementById(`ex-cont-${exId}`);
        if (ex.type === 'qcm' || ex.type === 'multiselect') {
            const btns = cont.querySelectorAll('button.option-btn');
            btns.forEach(b => b.classList.remove('selected'));
            answersById[exId] = ex.type === 'multiselect' ? [] : null;
            btns.forEach(b => {
                const val = b.innerText.trim();
                const should = Array.isArray(ex.answer) ? ex.answer.includes(val) : val === String(ex.answer).trim();
                if (should) b.click();
            });
        } else if (ex.type === 'input' || ex.type === 'fraction_scenario') {
            const inp = cont.querySelector('input');
            if (inp) { inp.value = ex.answer; answersById[exId] = ex.answer; }
        } else if (ex.type === 'cloze') {
            const sels = cont.querySelectorAll('select');
            sels.forEach((s, i) => { s.value = ex.answer[i]; saveClozeById(s, exId, i); });
        } else if (ex.type === 'drag_drop') {
            const zones = cont.querySelectorAll('.drop-zone');
            zones.forEach((z, i) => { z.textContent = ex.answer[i]; z.classList.add('filled'); });
            answersById[exId] = [...ex.answer];
        }
        setTimeout(() => validateExerciseById(exId), 200);
    }

    function validateExerciseById(exId) {
        const ex = stepData.exercises.find(e => e.id === exId);
        const userVal = answersById[exId];
        const fb = document.getElementById(`ex-fb-${exId}`);
        const wrapper = document.getElementById(`ex-wrapper-${exId}`);
        const btn = document.getElementById(`ex-bt-${exId}`);
        const sectionIdx = parseInt(wrapper.dataset.section);

        const expectedCount = Array.isArray(ex.answer) ? ex.answer.length : 1;
        const actualCount = Array.isArray(userVal) ? userVal.filter(v => v).length : (userVal ? 1 : 0);

        if (actualCount < expectedCount) {
            alert("R√©ponds √† la question avant de v√©rifier !"); return;
        }

        let isCorrect = false;
        if (Array.isArray(ex.answer)) {
            if (Array.isArray(userVal) && userVal.length === ex.answer.length) {
                const u = userVal.map(v => String(v).trim());
                const a = ex.answer.map(v => String(v).trim());
                isCorrect = ex.type === 'multiselect' ? u.sort().every((v, i) => v === a.sort()[i]) : u.every((v, i) => v === a[i]);
            }
        } else {
            const u = String(Array.isArray(userVal) ? userVal[0] : userVal).trim();
            const a = String(ex.answer).trim();
            isCorrect = u === a;
            if (!isCorrect && !isNaN(u) && !isNaN(a)) isCorrect = Math.abs(parseFloat(u) - parseFloat(a)) < 0.001;
        }

        if (isAdmin && !isCorrect) isCorrect = true; // Admin bypass

        if (isCorrect) {
            fb.innerHTML = "‚úÖ Tr√®s bien !"; fb.style.color = "var(--success)"; fb.style.display = "block";
            btn.style.display = "none"; wrapper.style.borderColor = "var(--success)";

            // Check if all exercises in this section are done
            const sectionWrapper = document.getElementById(`section-${sectionIdx}`);
            const allInSec = document.querySelectorAll(`[id^="ex-wrapper-"][data-section="${sectionIdx}"]`);
            const allBtnInSec = Array.from(allInSec).map(w => document.getElementById(`ex-bt-${w.id.replace('ex-wrapper-', '')}`));
            const allValidated = allBtnInSec.every(b => b.style.display === "none");

            if (allValidated) {
                if (sectionIdx < sections.length - 1) showContinueButton(sectionIdx);
                else document.getElementById('final-footer').style.display = 'block';
            }
        } else {
            fb.innerHTML = "‚ùå Essaie encore !"; fb.style.color = "var(--error)"; fb.style.display = "block";
            wrapper.style.borderColor = "var(--error)";
            setTimeout(() => { wrapper.style.borderColor = "var(--glass-border)"; fb.style.display = "none"; }, 2000);
        }
    }

    function renderFullContent() {
        container.innerHTML = '';
        sections.forEach((_, i) => {
            renderSection(i);
            const btn = document.getElementById(`next-btn-${i}`);
            if (btn) btn.remove();
        });
        document.querySelectorAll('button.btn-primary').forEach(b => b.style.display = "none");
        document.querySelectorAll('.interleaved-exercise').forEach(w => w.style.borderColor = "var(--success)");
        document.getElementById('final-footer').style.display = 'block';
    }

    async function finishStep() {
        try {
            const response = await fetch('/submit_step', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    step_id: stepData.id,
                    answers: {}
                })
            });
            const result = await response.json();
            if (result.xp_gained > 0) {
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                setTimeout(() => {
                    window.location.href = "{{ next_url if next_url else '/subjects/' + course.subject_id + '#' + step.id }}";
                }, 2000);
            } else {
                window.location.href = "{{ next_url if next_url else '/subjects/' + course.subject_id + '#' + step.id }}";
            }
        } catch (e) {
            console.error(e);
            alert("Erreur lors de la validation");
        }
    }
</script>
{% endblock %}