{% extends "base.html" %}

{% block title %}{{ step.title }} - Cours Toujours!{% endblock %}

{% block content %}
<div class="unit-container">
    <!-- Course Content -->
    <div class="glass glass-panel content-area animate-fade-in">
        <header style="border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem; margin-bottom: 2rem;">
            <a href="/subjects/{{ step.subject_id }}"
                style="color: var(--text-muted); text-decoration: none; font-size: 0.9rem;">&larr; Retour √† la route</a>
            <h1 style="margin-top: 0.5rem;">{{ step.title }}</h1>
            <p style="color: var(--secondary); font-size: 0.9rem;">{{ step.subtitle if step.subtitle else "" }}</p>
        </header>

        <!-- Dynamic Content Container -->
        <div id="progressive-content">
            <!-- Sections and exercises will be injected here -->
        </div>

        <div id="final-footer"
            style="display: none; margin-top: 3rem; text-align: center; padding: 2rem; border-top: 1px dashed var(--glass-border);">
            <h3 style="color: var(--success); margin-bottom: 1rem;">üéâ Bravo ! Tu as termin√© ce chapitre.</h3>
            <button class="btn-primary" onclick="finishStep()">Valider et continuer</button>
        </div>
    </div>
</div>

<script id="course-markdown" type="application/json">{{ course.content_markdown | tojson }}</script>



<style>
    .theory-section {
        margin-bottom: 2rem;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease;
    }

    .theory-section.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .interleaved-exercise {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 2rem 0;
        display: none;
    }

    .interleaved-exercise.visible {
        display: block;
        border-left: 4px solid var(--secondary);
    }

    .exercise-done {
        border-left-color: var(--success) !important;
        background: rgba(46, 204, 113, 0.05) !important;
    }

    .drop-zone {
        display: inline-block;
        min-width: 60px;
        min-height: 1.5em;
        border: 2px dashed var(--text-muted);
        border-radius: 6px;
        vertical-align: middle;
        margin: 0 0.5rem;
        text-align: center;
        padding: 0 0.5rem;
        background: rgba(255, 255, 255, 0.05);
    }

    .drop-zone.drag-over {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
    }

    .drop-zone.filled {
        border-style: solid;
        border-color: var(--success);
        color: var(--success);
        background: rgba(16, 185, 129, 0.1);
    }

    .draggable-item {
        padding: 0.5rem 1rem;
        background: var(--surface);
        border: 1px solid var(--glass-border);
        border-radius: 6px;
        cursor: grab;
        display: inline-block;
        margin: 0.2rem;
        user-select: none;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="/static/js/fraction_renderer.js"></script>
<script>
    const stepData = {
        id: "{{ step.id }}",
        exercises: {{ course.exercises | tojson if course.exercises else '[]' }}
    };
    const markdownText = JSON.parse(document.getElementById('course-markdown').textContent);
    stepData.rawContent = markdownText;
    const userId = {{ user.id }};
    const isAlreadyCompleted = {{ 'true' if user_progress and user_progress.is_completed else 'false' }};

    const sections = (stepData.rawContent || "").split('&&&').map(s => s.trim()).filter(s => s.length > 0);
    const container = document.getElementById('progressive-content');

    document.addEventListener('DOMContentLoaded', () => {
        if (isAlreadyCompleted) {
            renderFullContent();
        } else {
            renderSection(0);
        }
    });

    function renderSection(index) {
        if (index >= sections.length) {
            document.getElementById('final-footer').style.display = 'block';
            return;
        }

        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'theory-section';
        sectionDiv.id = `section-${index}`;

        // Protect Math
        const mathBlocks = [];
        const protectedContent = sections[index].replace(/(\$\$[\s\S]+?\$\$|\$[^\$\n]+?\$)/g, (match) => {
            const idx = mathBlocks.length;
            mathBlocks.push(match);
            return `<span class="math-px" data-idx="${idx}"></span>`;
        });

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = marked.parse(protectedContent);

        // Restore Math safely (No innerHTML roundtrip after restoration)
        tempDiv.querySelectorAll('.math-px').forEach(span => {
            const idx = span.getAttribute('data-idx');
            const mathText = mathBlocks[idx];
            span.replaceWith(document.createTextNode(mathText));
        });

        sectionDiv.appendChild(tempDiv);
        container.appendChild(sectionDiv);

        renderMathInElement(sectionDiv, {
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false }
            ],
            throwOnError: false
        });

        setTimeout(() => sectionDiv.classList.add('visible'), 10);

        const exercise = stepData.exercises[index];
        if (exercise) {
            renderExercise(index, exercise);
        } else {
            if (index < sections.length - 1) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn-secondary';
                nextBtn.style.margin = '1rem 0 3rem 0';
                nextBtn.textContent = 'Continuer la lecture ‚¨áÔ∏è';
                nextBtn.onclick = (e) => {
                    e.target.remove();
                    renderSection(index + 1);
                };
                container.appendChild(nextBtn);
            } else {
                renderSection(index + 1);
            }
        }
    }

    function renderExercise(index, ex) {
        const exDiv = document.createElement('div');
        exDiv.className = 'interleaved-exercise visible';
        exDiv.id = `ex-wrapper-${index}`;

        exDiv.innerHTML = `
            <div style="font-weight: bold; color: var(--secondary); margin-bottom: 1rem;">‚úçÔ∏è Petite v√©rification...</div>
            <div id="ex-content-${index}"></div>
            <div id="ex-feedback-${index}" style="margin-top: 1rem; font-weight: bold; display: none;"></div>
            <button id="ex-btn-${index}" class="btn-primary" style="margin-top: 1rem;" onclick="validateExercise(${index})">V√©rifier</button>
        `;
        container.appendChild(exDiv);

        const contentDiv = document.getElementById(`ex-content-${index}`);
        if (ex.type === 'qcm') {
            contentDiv.innerHTML = `
                <p style="margin-bottom: 1rem;">${ex.question}</p>
                <div class="options-grid" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${ex.options.map(opt => `
                        <button class="option-btn" onclick="selectOption(this, ${index}, '${opt}')">${opt}</button>
                    `).join('')}
                </div>
            `;
        } else if (ex.type === 'drag_drop') {
            let templateText = ex.template || '';
            let parts = templateText.split('???');
            let newHtml = '';

            parts.forEach((part, i) => {
                newHtml += part;
                if (i < parts.length - 1) {
                    const zoneId = `zone-${index}-${i}`;
                    newHtml += `<span class="drop-zone" id="${zoneId}" ondrop="onDrop(event, ${index}, ${i})" ondragover="allowDrop(event)"></span>`;
                }
            });

            contentDiv.innerHTML = `
                <div style="margin-bottom: 1rem; line-height: 2.2; font-size: 1.1rem;">${newHtml}</div>
                <div class="options-container" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${ex.options.map(opt => `
                        <div class="draggable-item" draggable="true" ondragstart="onDragStart(event, '${opt.replace(/'/g, "\\'")}')">${opt}</div>
                    `).join('')}
                </div>
            `;
        } else if (ex.type === 'fraction_scenario') {
            const cId = `visual-${index}`;
            contentDiv.innerHTML = `
                <div id="${cId}" style="margin: 0 auto 1.5rem auto; width: 100%; max-width: 300px; height: 300px;"></div>
                <p style="margin-bottom: 1rem; font-size: 1.1rem;">${ex.question}</p>
                <input type="text" class="flash-input" style="font-size: 1.1rem; padding: 0.6rem;" placeholder="Votre r√©ponse" onchange="answers[${index}] = this.value">
            `;
            setTimeout(() => {
                if (window.FractionRenderer) {
                    FractionRenderer.render(cId, ex);
                }
            }, 100);
        } else if (ex.type === 'input') {
            contentDiv.innerHTML = `
                <p style="margin-bottom: 1rem; font-size: 1.1rem;">${ex.question || ex.template}</p>
                <input type="text" class="flash-input" style="font-size: 1.1rem; padding: 0.6rem;" placeholder="Votre r√©ponse" onchange="answers[${index}] = this.value">
            `;
        } else {
            contentDiv.innerHTML = `<p>${ex.question || ex.template}</p><p class="text-muted">(Exercice non support√© en ligne pour le moment)</p>`;
        }

        renderMathInElement(contentDiv, {
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false }
            ],
            throwOnError: false
        });
    }

    const answers = {};

    function selectOption(btn, index, val) {
        const parent = btn.parentElement;
        parent.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        answers[index] = val;
    }

    // Drag and Drop Handlers
    function allowDrop(ev) {
        ev.preventDefault();
        ev.target.classList.add('drag-over');
    }

    function onDragStart(ev, value) {
        ev.dataTransfer.setData("text", value);
    }

    function onDrop(ev, index, zoneIndex) {
        ev.preventDefault();
        ev.target.classList.remove('drag-over');
        const data = ev.dataTransfer.getData("text");

        ev.target.textContent = data;
        ev.target.classList.add('filled');

        if (!answers[index]) answers[index] = [];
        if (!Array.isArray(answers[index])) answers[index] = [answers[index]];

        answers[index][zoneIndex] = data;
    }

    function validateExercise(index) {
        const ex = stepData.exercises[index];
        const userVal = answers[index];
        const feedback = document.getElementById(`ex-feedback-${index}`);
        const wrapper = document.getElementById(`ex-wrapper-${index}`);
        const btn = document.getElementById(`ex-btn-${index}`);

        if (!userVal) {
            alert("S'il te pla√Æt, r√©ponds √† la question avant de v√©rifier !");
            return;
        }

        let isCorrect = false;
        if (Array.isArray(ex.answer)) {
            if (Array.isArray(userVal) && userVal.length === ex.answer.length) {
                isCorrect = userVal.every((v, i) => String(v).trim() === String(ex.answer[i]).trim());
            }
        } else {
            // If userVal is array but answer is single string (single ???)
            const finalUserVal = Array.isArray(userVal) ? userVal[0] : userVal;
            isCorrect = String(finalUserVal).trim() === String(ex.answer).trim();
        }

        if (isCorrect) {
            feedback.innerHTML = "‚úÖ Excellent ! La suite üëá";
            feedback.style.color = "var(--success)";
            feedback.style.display = "block";
            wrapper.classList.add('exercise-done');

            // Lock inputs
            if (ex.type === 'qcm') {
                wrapper.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            } else if (ex.type === 'drag_drop') {
                wrapper.querySelectorAll('.draggable-item').forEach(d => d.draggable = false);
            }

            btn.remove();
            renderSection(index + 1);
        } else {
            feedback.innerHTML = "‚ùå Pas tout √† fait... r√©essaie !";
            feedback.style.color = "var(--error)";
            feedback.style.display = "block";
        }
    }

    function renderFullContent() {
        sections.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'theory-section visible';

            // Protect Math
            const mathBlocks = [];
            const protectedContent = s.replace(/(\$\$[\s\S]+?\$\$|\$[^\$\n]+?\$)/g, (match) => {
                const idx = mathBlocks.length;
                mathBlocks.push(match);
                return `<span class="math-px" data-idx="${idx}"></span>`;
            });

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = marked.parse(protectedContent);

            // Restore Math safely (No innerHTML roundtrip after restoration)
            tempDiv.querySelectorAll('.math-px').forEach(span => {
                const idx = span.getAttribute('data-idx');
                const mathText = mathBlocks[idx];
                span.replaceWith(document.createTextNode(mathText));
            });

            div.appendChild(tempDiv);
            container.appendChild(div);

            renderMathInElement(div, {
                delimiters: [{ left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }],
                throwOnError: false
            });
            if (i < sections.length - 1) {
                const hr = document.createElement('hr');
                hr.style.margin = '3rem 0'; hr.style.opacity = '0.1';
                container.appendChild(hr);
            }
        });
        document.getElementById('final-footer').style.display = 'block';
    }

    async function finishStep() {
        try {
            const response = await fetch('/submit_step', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    step_id: stepData.id,
                    answers: {}
                })
            });
            const result = await response.json();
            if (result.xp_gained > 0) {
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                setTimeout(() => { window.location.href = `/subjects/{{ course.subject_id }}`; }, 2000);
            } else {
                window.location.href = `/subjects/{{ course.subject_id }}`;
            }
        } catch (e) {
            console.error(e);
            alert("Erreur lors de la validation");
        }
    }
</script>
{% endblock %}