{% extends "base.html" %}

{% block title %}FLASH : {{ course.title }} - Cours Toujours!{% endblock %}

{% block head %}
<style>
    :root {
        --flash-primary: #f59e0b;
        --flash-secondary: #8b5cf6;
    }

    body {
        overflow-x: hidden;
    }

    .flash-container {
        max-width: 800px;
        margin: 2rem auto;
        text-align: center;
        min-height: 80vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    /* Modal / Popup Style */
    .flash-popup {
        background: rgba(30, 30, 35, 0.95);
        backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 3rem;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        position: relative;
        overflow: hidden;
        animation: popupIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        max-width: 600px;
        margin: 0 auto;
    }

    @keyframes popupIn {
        from {
            transform: scale(0.8) translateY(20px);
            opacity: 0;
        }

        to {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
    }

    .flash-popup.out {
        animation: popupOut 0.3s forwards;
    }

    @keyframes popupOut {
        to {
            transform: scale(0.9) translateY(-20px);
            opacity: 0;
        }
    }

    .question-text {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 2rem;
        background: linear-gradient(135deg, white, #ccc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .flash-input {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid var(--glass-border);
        border-radius: 12px;
        color: white;
        font-size: 1.5rem;
        padding: 1rem;
        width: 100%;
        text-align: center;
        transition: all 0.3s;
    }

    .flash-input:focus {
        border-color: var(--flash-primary);
        outline: none;
        box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
    }

    .progress-bar-container {
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        max-width: 600px;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        z-index: 100;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--flash-primary), var(--flash-secondary));
        width: 0%;
        transition: width 0.5s ease;
    }

    .feedback-msg {
        margin-top: 1rem;
        font-size: 1.2rem;
        font-weight: bold;
        min-height: 1.5em;
    }

    .btn-next {
        margin-top: 2rem;
        background: var(--flash-primary);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 0.8rem 2rem;
        font-size: 1.2rem;
        cursor: pointer;
        transition: transform 0.2s;
        display: none;
        /* Hidden by default */
    }

    .btn-next:hover {
        transform: scale(1.05);
    }

    .flash-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 0.8;
        }

        50% {
            transform: scale(1.1);
            opacity: 1;
        }

        100% {
            transform: scale(1);
            opacity: 0.8;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="progress-bar-container">
    <div id="progress-fill" class="progress-fill"></div>
</div>

<div class="flash-container">
    <div id="game-area">
        <!-- Dynamic Content -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/fraction_renderer.js"></script>
<script>
    const courseData = {
        id: "{{ course.id }}",
        subjectId: "{{ course.subject_id }}",
        exercises: {{ exercises | tojson }}
    };
    const userId = {{ user.id }};
    const stepId = "{{ step.id }}";

    let currentIndex = 0;
    let userAnswers = {};
    let correctCount = 0;

    document.addEventListener('DOMContentLoaded', () => {
        showQuestion(currentIndex);
    });

    function showQuestion(index) {
        const container = document.getElementById('game-area');

        if (index >= courseData.exercises.length) {
            finishGame();
            return;
        }

        const ex = courseData.exercises[index];
        const progress = ((index) / courseData.exercises.length) * 100;
        document.getElementById('progress-fill').style.width = `${progress}%`;

        // Generate HTML based on type
        // For tables, it's mostly 'input'.
        let innerHTML = '';

        if (ex.type === 'input') {
            innerHTML = `
                <div class="flash-icon">‚ö°</div>
                <div class="question-text">${ex.question}</div>
                <input type="text" class="flash-input" id="input-${ex.id}" placeholder="?" autocomplete="off">
                <div id="feedback" class="feedback-msg"></div>
                <div style="margin-top: 2rem;">
                    <button id="btn-validate" class="btn-primary" style="padding: 0.8rem 2rem; border-radius: 50px;">Valider</button>
                    <button id="btn-next" class="btn-next">Suivant &rarr;</button>
                </div>
            `;
        } else {
            // Fallback for other types (simplified for flash)
            innerHTML = `
                <div class="question-text">${ex.question || 'Question'}</div>
                <div id="options-area"></div>
                <div id="feedback" class="feedback-msg"></div>
                <button id="btn-next" class="btn-next">Suivant &rarr;</button>
             `;
        }

        const popup = document.createElement('div');
        popup.className = 'flash-popup';
        popup.innerHTML = innerHTML;

        container.innerHTML = '';
        container.appendChild(popup);

        // Render Math
        renderMathInElement(popup, {
            delimiters: [{ left: "$", right: "$", display: false }]
        });

        // Focus input
        const input = document.getElementById(`input-${ex.id}`);
        if (input) {
            input.focus();
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (document.getElementById('btn-validate').style.display !== 'none') {
                        validateAnswer();
                    } else {
                        nextQuestion();
                    }
                }
            });
        }

        const btnVal = document.getElementById('btn-validate');
        if (btnVal) btnVal.onclick = validateAnswer;

        document.getElementById('btn-next').onclick = nextQuestion;
    }

    function validateAnswer() {
        const ex = courseData.exercises[currentIndex];
        const input = document.getElementById(`input-${ex.id}`);
        const feedback = document.getElementById('feedback');
        const btnNext = document.getElementById('btn-next');
        const btnValidate = document.getElementById('btn-validate');

        if (!input) return;

        const val = input.value.trim();
        if (!val) return;

        userAnswers[ex.id] = val;

        const isCorrect = (val === ex.answer);

        if (isCorrect) {
            feedback.textContent = "BRAVO !";
            feedback.style.color = "var(--success)";
            correctCount++;
            confetti({
                particleCount: 50,
                spread: 60,
                origin: { y: 0.7 }
            });
        } else {
            feedback.textContent = `Rat√©... C'√©tait ${ex.answer}`;
            feedback.style.color = "var(--error)";
        }

        input.disabled = true;
        if (btnValidate) btnValidate.style.display = 'none';
        btnNext.style.display = 'inline-block';
        btnNext.focus();
    }

    function nextQuestion() {
        // Animation out
        const popup = document.querySelector('.flash-popup');
        popup.classList.add('out');

        setTimeout(() => {
            currentIndex++;
            showQuestion(currentIndex);
        }, 300);
    }

    async function finishGame() {
        const container = document.getElementById('game-area');
        document.getElementById('progress-fill').style.width = `100%`;

        container.innerHTML = `
            <div class="flash-popup">
                <h1>‚ö° termin√© !</h1>
                <p style="font-size: 1.5rem; margin: 1rem 0;">Score: ${correctCount} / ${courseData.exercises.length}</p>
                <div id="final-msg">Envoi des r√©sultats...</div>
            </div>
        `;

        confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });

        // Submit to backend
        try {
            const response = await fetch('/submit_test_step', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    step_id: stepId,
                    answers: userAnswers,
                    generated_exercises: courseData.exercises
                })
            });

            const result = await response.json();

            let masteryMsg = "";
            let mastery = result.mastery;
            if (mastery === 3) masteryMsg = "üèÜ MA√éTRISE OR ! (3/3)";
            else if (mastery === 2) masteryMsg = "ü•à Ma√Ætrise Argent (2/3)";
            else if (mastery === 1) masteryMsg = "ü•â Ma√Ætrise Bronze (1/3)";
            else masteryMsg = "Continue tes efforts !";

            document.getElementById('final-msg').innerHTML = `
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 10px; margin: 1rem 0;">
                    <h2 style="color: var(--flash-primary);">${masteryMsg}</h2>
                    <p>XP Gagn√©: <strong>+${result.xp_gained}</strong></p>
                </div>
                <a href="/subjects/${courseData.subjectId}#${stepId}" class="btn-primary" style="margin-top:1.5rem; display:inline-block; font-size: 1.3rem; padding: 1rem 3rem; text-decoration: none;">
                    Retour au parcours &rarr;
                </a>
            `;

        } catch (e) {
            console.error(e);
            document.getElementById('final-msg').textContent = "Erreur de sauvegarde.";
        }
    }
</script>
{% endblock %}