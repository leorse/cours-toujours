{% extends "base.html" %}

{% block title %}{{ subject.name }} - LearnFlow{% endblock %}

{% block content %}
<header style="margin-bottom: 3rem; display: flex; align-items: center; gap: 1rem;">
    <a href="/dashboard" class="btn-secondary">&larr; Retour</a>
    <h1 style="font-size: 2.5rem;">{{ subject.name }}</h1>
    <a href="/flash/{{ subject.id }}" class="flash-btn" title="Mode Flash !">
        ⚡
    </a>
</header>

<style>
    .flash-btn {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        text-decoration: none;
        color: white;
        box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        animation: pulse-gold 2s infinite;
    }

    .flash-btn:hover {
        transform: scale(1.2) rotate(15deg);
        box-shadow: 0 0 25px rgba(245, 158, 11, 0.6);
    }

    @keyframes pulse-gold {
        0% {
            box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
        }

        70% {
            box-shadow: 0 0 0 15px rgba(245, 158, 11, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
        }
    }
</style>

<div class="glass glass-panel animate-fade-in">
    <div class="chapter-list">
        {# Grouper par catégorie en conservant l'ordre #}
        {% set grouped = [] %}
        {% set cats_seen = {} %}

        {# On trie d'abord tous les cours par category_order et course.order #}
        {% for course in courses|sort(attribute='category_order,order') %}
        {% set cat_name = course.category_name or "Général" %}
        {% if cat_name not in cats_seen %}
        {% set _ = cats_seen.update({cat_name: grouped|length}) %}
        {% set _ = grouped.append({'name': cat_name, 'courses': []}) %}
        {% endif %}
        {% set cat_idx = cats_seen[cat_name] %}
        {% set _ = grouped[cat_idx]['courses'].append(course) %}
        {% endfor %}

        {% for section in grouped %}
        <div class="category-section" style="margin-bottom: 2rem;">
            <h3
                style="padding: 1rem; border-bottom: 1px solid var(--glass-border); color: var(--secondary); background: rgba(255,255,255,0.02);">
                {{ section.name }}
            </h3>
            {% for course in section.courses %}
            <a href="/unit/{{ course.id }}" class="chapter-item">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-weight: 800; color: var(--text-muted); width: 30px;">{{ loop.index }}</span>
                    <span style="font-size: 1.1rem; font-weight: 500;">{{ course.title }}</span>
                </div>

                {% if course.id in completed_courses %}
                <span class="chapter-status done">Terminé</span>
                {% else %}
                <span class="chapter-status">À faire</span>
                {% endif %}
            </a>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}